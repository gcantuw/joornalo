<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../styles/shared.html">

<link rel="import" href="./util/app-viewport.html">
<link rel="import" href="./util/app_cookie.html">
<link rel="import" href="./util/app-spinner.html">
<link rel="import" href="./blocks/block-error.html">
<link rel="import" href="./blocks/block-banner.html">
<link rel="import" href="./blocks/block-galleries.html">
<link rel="import" href="./blocks/block-top-news.html">
<link rel="import" href="./blocks/block-past-columns.html">


<dom-module id="page-news">
  <template>
    <style include="shared">

      :host {
        display: block;
        margin: 1rem 0 2rem;
      }
      .page {
        margin: 2rem 0 0;
      }
      .news {
        padding: 0 3rem 0 0;
        color: #333;
      }

      @media (max-width: 991px) {
        .news {
          padding: 0;
        }
        .section.border-bottom {
          border-bottom: none;
          margin-bottom: 0px;
        }
      }
      h2 {
        @apply --joornalo-h2;
        margin: 0;
        font-weight: normal;
      }
      [mobile] h2 {
        @apply --joornalo-h3;
        font-weight: normal;
      }
      .images {
        position: relative;
        color: #FFF;
        margin-top: .5rem;
      }
      .images h6 {
        margin: 0;
        color: #777;
        font-size: 0.85rem;
        line-height: 1rem;
        font-weight: 300;
        margin-bottom: 1.5rem;
      }
      .images .left {
        display: none;
        position: absolute;
        top: 45%;
        left: 0.5rem;
        color: red;
      }
      .images .right {
        display: none;
        position: absolute;
        top: 45%;
        right: 0.5rem;
        color: red;
      }
      [loop].images .left,
      [loop].images .right {
        display: block;
        cursor: pointer;
        font-size: 2rem;
        color: #fff;
        opacity: .4;
      }
      [loop].images .left:hover,
      [loop].images .right:hover {
        opacity: 1;
      }
      [class^="icon-"], [class*=" icon-"] {
        @apply --joornalo-icon;
        cursor: pointer;
        color: #666;
      }
      [class^="icon-"]:hover, [class*=" icon-"]:hover {
        color: #999;
      }
      .icon-circle-right:before {
        content: "\ea42";
        color: #FFF;
      }
      .icon-circle-left:before {
        content: "\ea44";
        color: #FFF;
      }
      .icon-mail:before {
        content: "\ea83";
        padding-right: .5rem;
      }
      .icon-facebook2:before {
        content: "\ea91";
      }
      .icon-twitter:before {
        content: "\ea96";
      }
      .icon-linkedin:before {
        content: "\eac9";
      }
      .share {
        font-size: 1.4rem;
        color: #666;
        margin-top: .8rem;
      }

      .share.mobile {
        margin-top: .8rem;
        border-top: 1px dotted #ddd;
        border-bottom: 1px dotted #ddd;
        padding-top: .2rem;

      }

      .icon-like {
        display: inline-block;
        height: 16px;
        width: 20px;
        background: url(../../images/icons/like.svg) no-repeat top left;
        background-size: 16px;
        cursor: pointer;
      }

      [voted] .icon-like {
        background: url(../../images/icons/likeVoted.svg) no-repeat top left;
        cursor: none;
      }

      .left-column .section {
        @apply --joornalo-h4;
        font-weight: 500;
        color: #cc0002;
      }
      .left-column .section:hover {
        text-decoration: underline;
      }
      .left-column .date {
        font-size: .75rem;
        font-weight: 300;
        margin: 0;
        line-height: 1rem;
        color: #777;
      }
      .left-column .author {
        font-size: 1rem;
        font-weight: normal;
        margin: 0.3rem 0 0;;
        line-height: 1.2rem;
        color: #3699A9
      }
      .likes {
        margin: 0.3rem 0;
        line-height: 1rem;
        color: #cc0002;
        display: inline-block;
        font-size: 1.5rem;
      }
      .border-bottom {
        border-bottom: 1px dotted #ddd;
        margin-bottom: .8rem;
        padding-bottom: .8rem;
      }

      .column {
        text-align: right;
        border-top: 1px dotted #ddd;
        border-bottom: 1px dotted #ddd;
        margin-bottom: .8rem;
        padding: .8rem .8rem .8rem 0;
        color: #3699A9;
        background: linear-gradient(to right, #FFF 0%, #efefef 100%);
      }

      .column h3 {
        @apply --joornalo-h3;
        font-weight: 400;
      }
      .column h4 {
        @apply --joornalo-h4;
        font-weight: 300;
      }

      .profile {
        background: #EFEFEF;
        padding: 0 .3rem;
      }

      .profile h3 {
        @apply --joornalo-h4;
        font-weight: 500;
        color: #cc0002;
        margin-top: .8rem;
        font-size: 1rem;
        display: inline-block;
        margin-top: 0;
      }
      .profile p {
        @apply --joornalo-p;
        font-weight: 400;
        color: #666;
        font-size: .875rem;
        display: inline-block;
        margin: .5rem 0;
      }
      .content{
        opacity: 1;
        -webkit-transition: opacity 0.5s; /* Safari */
        transition: opacity 0.5s;
      }
      .content[hide] {
        opacity: 0;
      }
    </style>

    <app-route
        route="{{route}}"
        pattern="/news/:id"
        data="{{routeData}}"></app-route>

    <app-cookie id="cookie"></app-cookie>

    <app-viewport xl="{{xl}}" lg="{{lg}}" md="{{md}}" sm="{{sm}}"></app-viewport>

    <app-spinner loading="[[spinner]]"></app-spinner>

    <block-error error-message="[[errorMessage]]"></block-error>

    <div class="content" hide$=[[!found]]>
      <template is="dom-if" if="{{gMd}}">
        <div class="row">
          <div class="col-12">
            <div class="block-top">
              <block-banner size="b980x90"></block-banner>
            </div>
          </div>
        </div>
      </template>
      
      <div class="row page" mobile$="[[sm]]">

        <div class="col-lg-2 left-column">

          <div hidden$="[[!news]]">

            <a href="#/front/[[news.section-id]]">
                <h3 class="section border-bottom">[[news.section]]</h3>
            </a>
            
            <template is="dom-if" if="{{gMd}}">

              <div class="share border-bottom">
                
                <a href="[[facebookLink]]" target="_blank">
                  <span class="icon-facebook2"></span>
                </a>
                <a href="[[twitterLink]]" target="_blank">
                  <span class="icon-twitter"></span>
                </a>
                <a href="[[linkedinLink]]" target="_blank">
                  <span class="icon-linkedin"></span>
                </a>
                <a href="[[mailToLink]]">
                  <span class="icon-mail"></span>
                </a>
                <h6 voted$="[[voted]]" class="likes" on-tap="_like"><span class="icon-like"></span>[[likes]]</h6>
              </div>

              <h6 class="date">[[date]]</h6>
              <h6 class="author border-bottom">[[news.author.name]]</h6>
            
              <div hidden$="[[!news.author.profile]]" class="profile">
                <h3>Perfil del Autor</h3>
                <p inner-h-t-m-l=[[news.author.profile]]></p>
              </div>

            </template>

          </div>
        </div>

        <div class="col-lg-7">

          <div hidden$="[[!news]]">

            <div class="news">
              <div hidden$="[[!news.author.column]]" class="column">
                <h3>[[news.author.column]]</h3>
                <h4>[[news.author.name]]</h4>
              </div>

              <h2>[[news.title]]</h2>
              <h5 inner-h-t-m-l=[[news.desc]]></h5>

              <div class="images" loop$="[[loopImages]]" hidden$="[[!activeImage]]">

                <img src="[[activeImage.url]]">
                <h6 hidden$="[[!activeImage.label]]">[[activeImage.label]]</h6>
                <div class="left" on-tap="_left">
                  <span class="icon-circle-left"></span>
                </div>
                <div class="right" on-tap="_right">
                  <span class="icon-circle-right"></span>
                </div>

              </div>

              <template is="dom-if" if="{{!gMd}}">

                <div class="share mobile">
                  
                  <a href="[[facebookLink]]" target="_blank">
                    <span class="icon-facebook2"></span>
                  </a>
                  <a href="[[twitterLink]]" target="_blank">
                    <span class="icon-twitter"></span>
                  </a>
                  <a href="[[linkedinLink]]" target="_blank">
                    <span class="icon-linkedin"></span>
                  </a>
                  <a href="[[mailToLink]]">
                    <span class="icon-mail"></span>
                  </a>
                  <h6 voted$="[[voted]]" class="likes" on-tap="_like"><span class="icon-like"></span>[[likes]]</h6>
                </div>

              </template>

              <p inner-h-t-m-l="[[news.text]]"></p>

            </div>

          </div>
        </div>

        <div class="col-lg-3">
          
          <block-past-columns columns="[[news.author.past-columns]]"></block-past-columns>
          <block-banner size="b300x250" class="margin-bottom"></block-banner>
          <block-top-news top-news="[[data.top-news]]"></block-top-news>
          <block-banner size="b300x250" class="margin-bottom"></block-banner>
          <block-galleries galleries="[[data.galleries]]"></block-galleries>
          <block-banner size="b300x250" class="margin-bottom"></block-banner>

        </div>

      </div>
    </div>

  </template>

  <script>

    class PageNews extends Polymer.GestureEventListeners(Polymer.Element) {
      static get is() { return 'page-news'; }
      static get properties() {
        return {

          id: {
            type: String
          },

          news: {
            type: Object
          },

          data: {
            type: Object
          },

          found: {
            type: Boolean,
            value: false
          },

          errorMessage: {
            type: String,
            value: null
          },

          gMd: {
            type: Boolean,
            value: false
          },

          activeImage: {
            type: Object,
            value: null
          },

          activeImageIndex: {
            type: Number,
            value: null
          },

          totalImages: {
            type: Number,
            value: null
          },

          loopImages: {
            type: Boolean,
            value: false
          },

          date: {
            type: String,
            value: null
          },

          url: {
            type: String,
            value: null
          },

          facebookLink: {
            type: String,
            value: null
          },

          twitterLink: {
            type: String,
            value: null
          },

          linkedinLink: {
            type: String,
            value: null
          },

          mailToLink: {
            type: String,
            value: null
          },

          likes: {
            type: Number,
            value: null
          },

          voted: {
            type: Boolean,
            value: false
          },

          spinner: {
            type: Boolean,
            value: true
          }

        };
      }

      static get observers() {
        return [
          '_newsChanged(routeData.id)',
          '_greaterMd(xl, lg)'
        ]
      } 

      constructor() {
        super();

        //this._init();
        //window.store.subscribe('news', this._init.bind(this));
      }

      ready(){
        super.ready();
        if(!this.$.cookie.cookiesEnabled()) { 
          this.voted = true;
        } else {
          if(this.$.cookie.getCookie('nv' +  this.id)) this.voted = true;
        }
      }

      _greaterMd(xl, lg) {
        this.gMd = (xl || lg);
      }

      _newsChanged(id) {
        this.found = false;
        this.errorMessage = null;
        this.spinner = true;
        this.activeImage = null;
        this.news = null;
        this.likes = null;
        this.url  = null;
        this.date = null;
        this.totalImages = 0;


        //console.log("News Id:", id);
        this.id = id;

        let api = 'json/news/news.asp?id=' + id;

        // if(id=='765721') {
        //   api = 'json/news/newsColumn.json?id=' + id;
        // }
        window.ajax.request('GET', api, null, (data) => {

          this.spinner = false;

          if (data.success) {
            this.found = true;
            this.news = data;
            this.likes = data.likes;
            this.url = window.location.origin + '/#/news/' + data.id;
            this.date = this._convertDate(data.date);

            this._socialMediaLinks();
            this._imageProcessing();
          } else {
            this.errorMessage = data.error.message;
            // if (data.status == 404) {
            //   this.notFound = true;
            // } else {

            // }


          }

        }, (err) => { console.log('error-------'); });


        api = 'json/news/column-data.json';
        window.ajax.request('GET', api, null, (data) => {

          this.data = data;

        }, (err) => this.setData(err));

      }

      _convertDate(dateString) {
        let days = ['Domingo','Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'],
            months = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'],
            date = new Date(dateString);

        return days[date.getDay()] + ', ' + months[date.getMonth()] + ' ' + date.getDate() + ', ' + date.getFullYear();

      }

      _imageProcessing() {
        this.totalImages = this.news.images.length;
        if(this.totalImages > 0) {
          this.activeImageIndex = 0;
          this.activeImage = this.news.images[0];
          if(this.totalImages > 1) {
            this.loopImages = true;
          }
        }
      }

      _socialMediaLinks() {
        this.facebookLink = "https://www.facebook.com/dialog/share?app_id=1914179482237147&href=" + encodeURIComponent(this.url);

        this.twitterLink = "https://twitter.com/intent/tweet?text=" + encodeURIComponent(this.news.title) + "&url=" + encodeURIComponent(this.url);

        this.linkedinLink = "https://www.linkedin.com/shareArticle?mini=true&title=" + encodeURIComponent(this.news.title) + "&url=https" + encodeURIComponent(this.url);

        this.mailToLink = "mailto:?subject=" + encodeURIComponent(this.news.title) + "&body=" + encodeURIComponent(this.url);
      }

      _left() {
        this.activeImageIndex--;
        this._calculateImage();
      }

      _right() {
        this.activeImageIndex++;
        this._calculateImage();
      }

      _calculateImage() {
        if(this.totalImages <= this.activeImageIndex) this.activeImageIndex = 0;
        if(0 > this.activeImageIndex) this.activeImageIndex = this.totalImages - 1;
        this.activeImage = this.news.images[this.activeImageIndex];
      }

      _like() {
        if(!this.voted) {
          this.$.cookie.setCookie('nv' +  this.id, '1');
          let api = 'json/news/like.json?id=' +  this.id;
          window.ajax.request('GET', api, null, (data) => {

            this.likes = data.likes;
            this.voted = true;


          }, (err) => this.setData(err));
        }
      }

    }

    window.customElements.define(PageNews.is, PageNews);
  </script>
</dom-module>