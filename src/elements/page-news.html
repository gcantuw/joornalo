<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../styles/shared.html">

<link rel="import" href="./util/app-viewport.html">
<link rel="import" href="./util/app_cookie.html">
<link rel="import" href="./util/app-spinner.html">
<link rel="import" href="./blocks/block-error.html">
<link rel="import" href="./blocks/block-banner.html">
<link rel="import" href="./blocks/block-video.html">
<!-- <link rel="import" href="./blocks/block-galleries.html"> -->
<!-- <link rel="import" href="./blocks/block-media.html"> -->
<link rel="import" href="./blocks/block-top-news.html">
<link rel="import" href="./blocks/block-other-news.html">
<link rel="import" href="./blocks/block-past-columns.html">
<link rel="import" href="./blocks/block-radio.html">
<link rel="import" href="./blocks/block-img.html">


<dom-module id="page-news">
  <template>
    <style include="shared">

      :host {
        display: block;
        margin: 1rem 0 2.1rem;
      }

      *, *:after, *:before {
        @apply --initial;
      }

      .page {
        margin: 2rem 0 0;
      }
      .news {
        padding: 0 3rem 0 0;
        color: #333;
      }

      @media (max-width: 991px) {
        .news {
          padding: 0;
        }
        .section.border-bottom {
          border-bottom: none;
          margin-bottom: 0px;
        }
      }
      h2 {
        @apply --joornalo-h2;
        margin: 0;
        font-weight: normal;
        margin-bottom: 0.7rem;
      }
      h5 {
        margin-bottom: 0.7rem;
      }
      [mobile] h2 {
        @apply --joornalo-h3;
        font-weight: normal;
        line-height: 1.8rem;
      }
      .images {
        position: relative;
        color: #FFF;
        margin-top: .5rem;
      }
      .images h6 {
        margin: 0;
        color: #777;
        font-size: 0.85rem;
        line-height: 1rem;
        font-weight: 300;
        margin-bottom: 1.5rem;
      }
      .images .left {
        display: none;
        position: absolute;
        top: 45%;
        left: 0.5rem;
        color: red;
      }
      .images .right {
        display: none;
        position: absolute;
        top: 45%;
        right: 0.5rem;
        color: red;
      }
      [loop].images .left,
      [loop].images .right {
        display: block;
        cursor: pointer;
        font-size: 2rem;
        color: #fff;
        opacity: .4;
      }
      [loop].images .left:hover,
      [loop].images .right:hover {
        opacity: 1;
      }
      [class^="icon-"], [class*=" icon-"] {
        @apply --joornalo-icon;
        cursor: pointer;
        color: #666;
      }
      [class^="icon-"]:hover, [class*=" icon-"]:hover {
        color: #999;
      }
      .icon-circle-right:before {
        content: "\ea42";
        color: #FFF;
        text-shadow: 0 1px 1px #000;
      }
      .icon-circle-left:before {
        content: "\ea44";
        color: #FFF;
        text-shadow: 0 1px 1px #000;
      }
      .icon-mail:before {
        content: "\ea83";
        padding-right: .5rem;
      }
      .icon-facebook2:before {
        content: "\ea91";
      }
      .icon-twitter:before {
        content: "\ea96";
      }
      .icon-linkedin:before {
        content: "\eac9";
      }
      .icon-heart:before {
        content: "\e9da";
        font-size: 21px;
      }
      [voted] .icon-heart:before {
        color:#cc0002;
        cursor: default;
      }
      .share {
        font-size: 1.4rem;
        color: #666;
        margin-top: .8rem;
      }

      .share.mobile {
        margin-top: .8rem;
        border-top: 1px dotted #ddd;
        border-bottom: 1px dotted #ddd;
        padding-top: .2rem;

        display: flex;
      }

      .left-column .section {
        @apply --joornalo-h4;
        font-weight: 500;
        color: #cc0002;
        display: block;
      }
      .left-column .section:hover {
        text-decoration: underline;
      }
      .left-column .date {
        font-size: .75rem;
        font-weight: 300;
        margin: 0;
        line-height: 1rem;
        color: #777;
      }
      .left-column .author {
        font-size: 1rem;
        font-weight: normal;
        margin: 0.3rem 0 0;;
        line-height: 1.2rem;
        color: #3699A9
      }
      .date-author {
        font-size: 1rem;
        font-weight: 300;
        margin: 0 0 .5rem;
        line-height: 1rem;
        color: #777;
      }
      .date-author span {
        color: #3699A9
      }
      .likes {
        flex: 1;
        margin: 0.1rem 0.5rem 0 0;
        line-height: 1rem;
        color: #cc0002;
        display: inline-block;
        font-size: 1.5rem;
        text-align: right;
      }
      .border-bottom {
        border-bottom: 1px dotted #ddd;
        margin-bottom: .8rem;
        padding-bottom: .8rem;
      }

      .column {
        text-align: right;
        border-top: 1px dotted #ddd;
        border-bottom: 1px dotted #ddd;
        margin-bottom: .8rem;
        padding: .8rem .8rem .8rem 0;
        color: #3699A9;
        background: linear-gradient(to right, #FFF 0%, #efefef 100%);
      }

      .column h3 {
        @apply --joornalo-h3;
        font-weight: 400;
      }
      .column h4 {
        @apply --joornalo-h4;
        font-weight: 300;
      }

      .profile {
        background: #EFEFEF;
        padding: 0 .3rem;
      }

      .profile h3 {
        @apply --joornalo-h4;
        font-weight: 500;
        color: #cc0002;
        margin-top: .8rem;
        font-size: 1rem;
        display: inline-block;
        margin-top: 0;
      }
      .profile p {
        @apply --joornalo-p;
        font-weight: 400;
        color: #666;
        font-size: .875rem;
        display: inline-block;
        margin: .5rem 0;
      }
      .content{
        opacity: 1;
        -webkit-transition: opacity 0.5s; /* Safari */
        transition: opacity 0.5s;
      }
      .content[hide] {
        opacity: 0;
      }

      .news-content block-video{
        height: 300px;
      }

      @media (max-width: 575px) {
          .news-content block-video{
          height: 200px;
        }
      }

      .bannerLeft {
        margin-top: 1rem;

        position: absolute;
        left: 50%;
        margin-right: -50%;
        transform: translate(-50%, 0);
      }

    </style>

    <app-route
        route="{{route}}"
        pattern="/news/:id"
        data="{{routeData}}"></app-route>

    <app-cookie id="cookie"></app-cookie>

    <app-viewport xl="{{xl}}" lg="{{lg}}" md="{{md}}" sm="{{sm}}"></app-viewport>

    <app-spinner loading="[[spinner]]"></app-spinner>

    <block-error error-message="[[errorMessage]]"></block-error>

    <div class="content" hide$=[[!found]]>
      <template is="dom-if" if="{{gMd}}">
        <div class="row">
          <div class="col-12">
            <div class="block-top">
              <block-banner size="b980x90" section="[[section]]"></block-banner>
            </div>
          </div>
        </div>
      </template>
      
      <div class="row page" mobile$="[[sm]]">

        <div class="col-lg-2 left-column">

          <div hidden$="[[!news]]">

            <a href="#/front/[[news.section-id]]">
                <h3 class="section border-bottom">[[news.section]]</h3>
            </a>
            
            <template is="dom-if" if="{{gMd}}">

              <div class="share border-bottom">
                
                <div class="social">
                  <a href="[[facebookLink]]" target="_blank">
                    <span class="icon-facebook2"></span>
                  </a>
                  <a href="[[twitterLink]]" target="_blank">
                    <span class="icon-twitter"></span>
                  </a>
                  <a href="[[linkedinLink]]" target="_blank">
                    <span class="icon-linkedin"></span>
                  </a>
                  <a href="[[mailToLink]]">
                    <span class="icon-mail"></span>
                  </a>
                </div>
                <h6 voted$="[[voted]]" class="likes" on-tap="_like"><span class="icon-heart"></span> [[likes]]</h6>
              </div>

              <h6 class="date">[[date]]</h6>
              <h6 class="author">[[news.author.name]]</h6>
            
              <div hidden$="[[!news.author.profile]]" class="profile">
                <h3>Perfil del Autor</h3>
                <p inner-h-t-m-l=[[news.author.profile]]></p>
              </div>

              <block-banner class="bannerLeft" size="b160x600" section="[[section]]"></block-banner>

            </template>

          </div>
        </div>

        <div class="col-lg-7">

          <div hidden$="[[!news]]">

            <div class="news">
              <div hidden$="[[!news.author.column]]" class="column">
                <h3>[[news.author.column]]</h3>
                <h4>[[news.author.name]]</h4>
              </div>

              <h2>[[news.title]]</h2>

              <template is="dom-if" if="{{!gMd}}">
                <h6 class="date-author">[[date]] 
                  <template is="dom-if" if="{{news.author.name}}">
                    | <span>[[news.author.name]]</span>
                  </template>
                </h6>
              </template>

              <h5 inner-h-t-m-l=[[news.desc]]></h5>

              <div class="images" loop$="[[loopImages]]" hidden$="[[!activeImage]]">
                <block-img url="[[activeImage.url]]"></block-img>
                <h6 hidden$="[[!activeImage.label]]">[[activeImage.label]]</h6>
                <div class="left" on-tap="_left">
                  <span class="icon-circle-left"></span>
                </div>
                <div class="right" on-tap="_right">
                  <span class="icon-circle-right"></span>
                </div>

              </div>

              <template is="dom-if" if="{{!gMd}}">

                <div class="share mobile">
                  <div class="social">
                    <a href="[[facebookLink]]" target="_blank">
                      <span class="icon-facebook2"></span>
                    </a>
                    <a href="[[twitterLink]]" target="_blank">
                      <span class="icon-twitter"></span>
                    </a>
                    <a href="[[linkedinLink]]" target="_blank">
                      <span class="icon-linkedin"></span>
                    </a>
                    <a href="[[mailToLink]]">
                      <span class="icon-mail"></span>
                    </a>
                  </div>
                  <h6 voted$="[[voted]]" class="likes" on-tap="_like"><span class="icon-heart"></span> [[likes]]</h6>
                </div>

              </template>

              <p class="news-content" inner-h-t-m-l="[[news.text]]"></p>

            </div>

          </div>
        </div>

        <div class="col-lg-3">
          
          <block-radio></block-radio>
          <block-past-columns columns="[[news.author.past-columns]]"></block-past-columns>
          <block-banner size="b300x250" section="[[section]]" class="margin-bottom"></block-banner>
          <block-top-news top-news="[[data.top-news]]"></block-top-news>
          <block-other-news other-news="[[data.other-news]]"></block-other-news>
          
        </div>

      </div>
    </div>

  </template>

  <script>

    class PageNews extends Polymer.GestureEventListeners(Polymer.Element) {
      static get is() { return 'page-news'; }
      static get properties() {
        return {

          id: {
            type: String,
            observer: '_idChanged'
          },

          section: {
            type: String,
            value: null
          },

          news: {
            type: Object
          },

          data: {
            type: Object
          },

          found: {
            type: Boolean,
            value: false
          },

          errorMessage: {
            type: String,
            value: null
          },

          gMd: {
            type: Boolean,
            value: false
          },

          activeImage: {
            type: Object,
            value: null
          },

          activeImageIndex: {
            type: Number,
            value: null
          },

          totalImages: {
            type: Number,
            value: null
          },

          loopImages: {
            type: Boolean,
            value: false
          },

          date: {
            type: String,
            value: null
          },

          url: {
            type: String,
            value: null
          },

          urlShare: {
            type: String,
            value: null
          },

          facebookLink: {
            type: String,
            value: null
          },

          twitterLink: {
            type: String,
            value: null
          },

          linkedinLink: {
            type: String,
            value: null
          },

          mailToLink: {
            type: String,
            value: null
          },

          likes: {
            type: Number,
            value: null
          },

          voted: {
            type: Boolean,
            value: false
          },

          spinner: {
            type: Boolean,
            value: true
          },

          loadedData: {
            type: Array,
            value: []
          }

        };
      }

      static get observers() {
        return [
          '_newsChanged(routeData.id)',
          '_greaterMd(xl, lg)'
        ]
      } 

      // constructor() {
      //   super();
      // }

      _idChanged(){
        if(!this.$.cookie.cookiesEnabled()) { 
          this.voted = true;
        } else {
          let voted = this.$.cookie.getCookie('nv' +  this.id);
          this.voted = (voted) ? true : false;
        }
      }

      _greaterMd(xl, lg) {
        this.gMd = (xl || lg);
      }

      _newsChanged(id) {
        this.section = null;
        this.found = false;
        this.errorMessage = null;
        this.spinner = true;
        this.activeImage = null;
        this.news = null;
        this.likes = null;
        this.url  = null;
        this.urlShare = null;
        this.date = null;
        this.totalImages = 0;

        this.id = id;

        this._getNews();

      }

      _getNews(){
        if(this.loadedData[this.id]) {
          let timeDiff = (Date.now() - this.loadedData[this.id].time) / 1000 / 60;

          // only data from News is more than 10 minutes old
          if (timeDiff > 10) {
            this._loadNews();
          } else {
            this.spinner = false;
            this._processData(this.loadedData[this.id].data);
          }
        } else {
          this._loadNews();
        }

      }


      _loadNews(){
        let id = this.id;
        let api = 'json/news/news.asp?id=' + id;

        window.ajax.request('GET', api, null, (data) => {

          this.spinner = false;

          if (data.success) {

            this.section = data['section-id'];
            // handle 'Policomics'
            if (data['section-id'] == 'cartones') {
              data['section-id'] = 'opinion';
              data['section'] = 'Opinión';
            }

            if(data.media.length > 0) {
              data.text = this._embedTags(data.text);
            }

            setTimeout(() => {
              this.loadedData[this.id] = {
                time: Date.now(),
                data: data
              }

              this._processData(data);
            }, 0);


          } else {
            //this.errorMessage = data.error.message;
            window.location.hash = '/notfound';
            // if (data.status == 404) {
            //   this.notFound = true;
            // } else {

            // }
          }

        }, (err) => { console.log('error-------'); });  

      }

      _processData(data) {
        this.found = true;
        this.news = data;
        this.likes = data.likes;
        this.url = window.location.origin + '/#/news/' + data.id;
        this.urlShare = window.location.origin + '/share.asp?nid=' + data.id + '#/news/' + data.id;
        this.date = this._convertDate(data.date);  
        this.section = data['section-id'];

        this._updateMetaTags(data);
        this._socialMediaLinks();
        this._imageProcessing();
        this._embedMedia();

        let api = 'json/news/column-data.asp?id=' + data.id + '&s='+window.sectionClave[data['section-id']];
        window.ajax.request('GET', api, null, (data) => {
          this.data = data;
        }, (err) => this.setData(err));
      }

      _convertDate(dateString) {
        let days = ['Domingo','Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'],
            months = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'],
            date = new Date(dateString);

        return days[date.getDay()] + ', ' + months[date.getMonth()] + ' ' + date.getDate() + ', ' + date.getFullYear();
      }

      _imageProcessing() {
        this.totalImages = this.news.images.length;
        if(this.totalImages > 0) {
          this.activeImageIndex = 0;
          this.activeImage = this.news.images[0];
          this.loopImages = (this.totalImages > 1);
        }
      }

      _embedTags(text) {
        let x,y,tmp = text;
        x = tmp.indexOf("***video");
        if (x) y = tmp.indexOf("***", x+1);
        while(x>0) {
          tmp = tmp.substr(0, x) + '<block-video id="video' + tmp.substr(x+8,y-x-8) + '"></block-video>' + tmp.substr(y+3);

          x = tmp.indexOf("***video");
          if (x) y = tmp.indexOf("***", x+1);
        }
        return tmp;
      }

      _embedMedia() {
        this.news.media.forEach((element) => {
          if (this.shadowRoot.querySelector("#video"+element.num)) {
            this.shadowRoot.querySelector("#video"+element.num).video = element;
          }
        });
      }

      _socialMediaLinks() {
        this.facebookLink = "https://www.facebook.com/dialog/share?app_id=974004652805964&href=" + encodeURIComponent(this.urlShare);

        this.twitterLink = "https://twitter.com/intent/tweet?text=" + encodeURIComponent(this.news.title) + "&url=" + encodeURIComponent(this.urlShare);

        this.linkedinLink = "https://www.linkedin.com/shareArticle?mini=true&title=" + encodeURIComponent(this.news.title) + "&url=" + encodeURIComponent(this.urlShare);

        this.mailToLink = "mailto:?subject=" + encodeURIComponent(this.news.title) + "&body=" + encodeURIComponent(this.url);
      }

      _left() {
        this.activeImageIndex--;
        this._calculateImage();
      }

      _right() {
        this.activeImageIndex++;
        this._calculateImage();
      }

      _calculateImage() {
        if(this.totalImages <= this.activeImageIndex) this.activeImageIndex = 0;
        if(0 > this.activeImageIndex) this.activeImageIndex = this.totalImages - 1;
        this.activeImage = this.news.images[this.activeImageIndex];
      }

      _like() {
        if(!this.voted) {
          this.voted = true;
          //this.$.cookie.setCookie('nv' +  this.id, '1');
          let api = 'json/news/like.asp?id=' +  this.id;
          window.ajax.request('GET', api, null, (data) => {
            this.likes = data.likes;
            this.loadedData[this.id].data.likes = data.likes;
          }, (err) => this.setData(err));
        }
      }

      _updateMetaTags(data) {
        let desc = (data.desc.length > 200) ? data.desc.substr(0, 197) + '...' : data.desc,
            img = (data.images && data.images[0]) ? data.images[0].url : '',
            imgAltName = (data.images && data.images[0]) ? data.images[0].label : '';

        setTimeout(() => {
          let metaTags = {
            title: data.title + ' - ' + data.section,
            description: desc,
            image: img,
            url: window.location.href,
            card: img,
            imgAltName: imgAltName
          };
          window.store.publish('meta-tags', metaTags);
        }, 0);
      }

    }

    window.customElements.define(PageNews.is, PageNews);
  </script>
</dom-module>