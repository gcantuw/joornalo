<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="./util/app-viewport.html">
<link rel="import" href="./blocks/block-banner.html">
<link rel="import" href="./blocks/block-video.html">
<link rel="import" href="./blocks/block-video-thumb.html">

<link rel="import" href="../styles/shared.html">

<dom-module id="page-multimedia">
  <template>
    <style include="shared">
      :host {
        display: block;
        margin-bottom: 4rem;
      }

      *, *:after, *:before {
        @apply --initial;
      }

      .video {
        margin-bottom: 2rem;
      }

      block-video {
        height: 100%;
        margin-bottom: 1rem;
        height: 100%;
      }
      
      @media (max-width: 768px) {
        block-video {
          min-height: 52vw;
        }
      }

      .video h2 {
        line-height: 2.5rem;
        margin: 0 0 1rem;
      }

      .video h4 {
        line-height: 1.6rem;
        margin: 0 0 1rem;
      }

      .align-bottom {
        margin-top: 20px;
      }

      .topVideo {
        min-height: 398px;
      }

      @media (max-width: 991px) {
        .video h2 {
          font-size: 1.4rem;
          line-height: 1.5rem;
        }
      }
  
    </style>

    <app-route
        route="{{route}}"
        pattern="/multimedia/:id"
        data="{{routeData}}"></app-route>

    <app-viewport xl="{{xl}}" lg="{{lg}}" md="{{md}}" sm="{{sm}}"></app-viewport>

    <div class="page-title">
      <h3>Multimedia</h3>
    </div>

    <template is="dom-if" if="{{gMd}}">
      <div class="row">
        <div class="col-12">
          <div class="margin-bottom">
            <block-banner size="b980x90" module="4"></block-banner>
          </div>
        </div>
      </div>
    </template>

    <div class="video">

      <div class="row topVideo">
        <div class="col-lg-7 col-md-7">

          <block-video video=[[video]]></block-video>

        </div>

        <div class="col-lg-5 col-md-5">
          <h2>[[video.title]]</h2>
          <h4>[[video.desc]]</h4>

          <block-banner class="align-bottom" size="b300x250" module="4"></block-banner>

        </div>
      </div>

    </div>

      <div class="row">

        <template is="dom-repeat" items="{{multimedia}}" as="video">

          <div class="col-lg-2 col-md-3 col-sm-4 col-6">

            <span on-tap="_changeVideo">
              <block-video-thumb video="[[video]]" format="multi1"></block-video-thumb>
            </span>

          </div>

        </template>

      </div>

    </div>

  </template>

  <script>
  
    class PageMultimedia extends Polymer.GestureEventListeners(Polymer.Element) {
      static get is() { return 'page-multimedia'; }
      static get properties() {
        return {

          id: {
            type: String,
            value: null
          },

          multimedia: {
            type: Array
          },

          video: {
            type: Object,
            value: null
          },

          videoOld: {
            type: Object,
            value: null
          },

          gMd: {
            type: Boolean,
            value: false
          },

          time: {
            type: Number
          }

        };
      }

      static get observers() {
        return [
          '_multimediaChanged(routeData.id)',
          '_greaterMd(xl, lg)'
        ]
      }

      constructor() {
        super();
        this._loadData();
        window.store.subscribe('multimedia', this._getData.bind(this));
        window.store.subscribe('page-change', this._pageChange.bind(this));
      }

      _getData() {
        if(this.multimedia) {
          let timeDiff = (Date.now() - this.time) / 1000 / 60;
          // only data from Multimedia is more than 10 minutes old
          if (timeDiff > 10) {
            this._loadData();
          }
        } else {
          this._loadData();
        }
      }

      _pageChange(current) {
        if(current !== 'multimedia') {
          this.videoOld = this.video;
          this.video = null;
        } else {
          this.video = this.videoOld;
        }
      }

      _loadData() {
        this.id = null;
        setTimeout(() => {
          let api = 'json/media/multimedia.asp?id=' + this.id;
          window.ajax.request('GET', api, null, (data) => {
            this.multimedia = data.data;
            this.video = this.multimedia[0];
            this.time = Date.now();
          }, (err) => this.setData(err));
        }, 0);

      }

      _greaterMd(xl, lg) {
        this.gMd = (xl || lg);
      }

      _multimediaChanged(id) {
        this.id = id;
      }

      _changeVideo(e) {
        // console.log(e.model.video);
        this.video = e.model.video;
        if(!this.gMd) {
          window.scrollTo(0, 0);
        }
      }
    }

    window.customElements.define(PageMultimedia.is, PageMultimedia);
  </script>
</dom-module>
