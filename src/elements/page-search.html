<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="./util/search-input.html">
<link rel="import" href="./util/app-spinner.html">
<link rel="import" href="./util/app-viewport.html">
<link rel="import" href="../styles/shared.html">

<dom-module id="page-search">
  <template>
    <style include="shared">

      :host {
        display: block;
        
      }

      :host h2 {
        margin: 0;
        background: #eee;
        padding: 1rem;
      }

      .results {
        margin: 0 1rem 4rem;
      }

      .results p {
        margin: 2rem 0;
      }

      .result {
        display: flex;
        margin-bottom: 3rem;
      }

      .result h3 {
        color: #000;
      }

      .result .left {
        width: 100px;
        order: 1;
      }

      .result .img {
        width: 200px;
        margin: .3rem 2rem 0 0;
        order: 2;
      }

      .result [right].img {
        margin: .3rem 0 0 2rem;
        order: 4;
      }

      .result .right {
        flex: 1;
        order: 3;
      }

      .result h5 {
        color: #999;
        margin: 0;
        font-size: 1rem;
        font-weight: 400;
        padding: 1px 0 0 0;
      }

      .result h4 {
        color: #000;
        margin: 0;
        font-weight: 500;
      }

      .result h6 {
        color: #333;
        margin: 0;
        font-weight: 400;
      }

      .navigation {
        background: #666;
        color: #FFF;
        text-align: center;
        padding: .5rem;
        font-size: 1rem;
        cursor: pointer;
      }

      .empty em {
        font-weight: bold;
      }

    </style>

    <iron-location id="location"></iron-location>

    <app-viewport xl="{{xl}}" lg="{{lg}}" md="{{md}}" sm="{{sm}}"></app-viewport>

    <app-route
        route="{{route}}"
        pattern="/search/:keywords"
        data="{{routeData}}"></app-route>

    <app-spinner loading="[[spinner]]"></app-spinner>

    <h2>
      <search-input type="text" value="{{search::input}}" autofocus submit="{{submit}}"></search-input>
    </h2>

    <div class="results">

      <div class="empty" hidden$="[[!noResults]]">
        <p> No hay resultados para <em>[[keywords]]</em></p>

        <p>
          Sugerencias
          <ul>
            <li>Asegúrese de que las palabras esten escritas correctamente.</li>
            <li>Utilice diferentes palabras.</li>
            <li>Intente palabras más genéricas.</li>
          </ul>
        </p>
      </div>

      <p hidden$="[[empty]]">Results for: [[keywords]]</p>

      <div class="row">

        <template is="dom-repeat" items="{{results}}" as="news">

          <div class="col-lg-12">
            <a class="result" href="#/news/[[news.id]]">
              <div class="left" hidden$="[[!gMd]]">
                <h5>[[news.date]]</h5>
              </div>
              <template is="dom-if" if="{{gSm}}">
                <div hidden$="[[!news.img]]" right$="[[md]]" class="img">
                  <img src="[[news.img]]">
                </div>
              </template>
              <div class="right">
                <h5 hidden$="[[gMd]]">[[news.date]]</h5>
                <h4>[[news.title]]</h4>
                <h6>[[news.desc]]</h6>
              </div>
            </a>
          </div>

        </template>

      </div>

      <div hidden$="[[!more]]" class="navigation" on-tap="_more">
        Mostrar más resultados
      </div>

    </div>

  </template>

  <script>

    class PageSearch extends Polymer.GestureEventListeners(Polymer.Element) {
      static get is() { return 'page-search'; }
      static get properties() {
        return {

          search: {
            type: String,
            value: null
          },

          keywords: {
            type: String
          },

          results: {
            type: Array
          },

          submit: {
            type: Boolean,
            value: false,
            observer: '_submitChange'
          },

          page: {
            type: Number,
            value: 1
          },

          spinner: {
            type: Boolean,
            value: false
          },

          noResults: {
            type: Boolean,
            value: false
          },

          more: {
            type: Boolean,
            value: false
          },

          empty: {
            type: Boolean,
            value: true
          },

          gMd: {
            type: Boolean,
            value: false
          },

          gSm: {
            type: Boolean,
            value: false
          }

        };
      }

      static get observers() {
        return [
          '_searchChanged(routeData.keywords)',
          '_greaterSm(xl, lg, md)'
        ];
      }

      constructor() {
        super();
        window.store.subscribe('search', this._reset.bind(this));
      }

      _reset() {
        this.search = null;
        this.noResults = false;
        this.more = false;
        this.empty = true;
        this.results = [];
      }

      _searchChanged(keywords) {

        if(keywords && keywords.length>0) {
          this.keywords = keywords.replace(/\+/g, " ");

          this.search = this.keywords.replace(/\+/g, " ");

          let api = 'json/news/search.json?k=' + keywords.replace(/\-/g, "+");
          
          this.spinner = true;

          window.ajax.request('GET', api, null, (data) => {

            this.spinner = false;
            this.results = data.results;
            this.more = data.more;
            if(data.results.length>0) {
              this.noResults = false;
              this.empty = false;
            } else {
              this.noResults = true;
              this.more = false;
              this.empty = true;
            }
            this.page = 1;

          }, (err) => this.setData(err));

        } else {
          this.keywords = '';
          this.results = [];
          this.empty = true;
          this.more = false;
        }

      }

      _submitChange() {
        if(this.submit) {
          this._search();
        }
      }

      _search() {
        let search = this.search.replace(/\s+/g,' ').trim().replace(/ /g, "+");
        this.$.location.set('hash', '/search/'+search);
      }

      _more() {
        this.page++;

        let api = 'json/news/search.json?k=' + this.keywords.replace(/\-/g, "+") + '&p=' + this.page;
        
        this.spinner = true;
        window.ajax.request('GET', api, null, (data) => {

          this.spinner = false;

          this.results = this.results.concat(data.results);
          this.more = data.more;

        }, (err) => this.setData(err));
      }

      _greaterSm(xl, lg, md) {
        this.gMd = (xl || lg);
        this.gSm = (xl || lg || md);
      }

    }

    window.customElements.define(PageSearch.is, PageSearch);
  </script>
</dom-module>