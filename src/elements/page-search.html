<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="./util/search-input.html">
<link rel="import" href="./util/app-spinner.html">
<link rel="import" href="./util/app-viewport.html">
<link rel="import" href="./util/drop-down.html">
<link rel="import" href="./util/app-viewport.html">
<link rel="import" href="./util/app-pagination.html">
<link rel="import" href="../styles/shared.html">

<dom-module id="page-search">
  <template>
    <style include="shared">

      :host {
        display: block;
        
      }

      *, *:after, *:before {
        @apply --initial;
      }

      :host h2 {
        margin: 0;
        background: var(--light-background-color);
        padding: 1rem;
      }

      .results {
        margin: 0 1rem 4rem;
      }

      .results p {
        margin: 2rem 0;
      }

      .result {
        display: flex;
        margin-bottom: 3rem;
      }

      .result h3 {
        color: #000;
      }

      .result .left {
        width: 100px;
        order: 1;
      }

      .result .img {
        width: 200px;
        margin: .3rem 2rem 0 0;
        order: 2;
      }

      .result [right].img {
        margin: .3rem 0 0 2rem;
        order: 4;
      }

      .result .right {
        flex: 1;
        order: 3;
      }

      .result h5 {
        color: #999;
        margin: 0;
        font-size: 1rem;
        font-weight: 400;
        padding: 1px 0 0 0;
      }

      .result h4 {
        color: #000;
        margin: 0;
        font-weight: 500;
      }

      .result h4.section {
        color: var(--accent-color);
        font-size: 0.9rem;
        line-height: 1.3rem;
      }

      .result h6 {
        color: #333;
        margin: 0;
        font-weight: 400;
        margin-top: .2rem;
      }

      .results em {
        font-style: italic;
        font-weight: 600;
      }

      .navigation {
        background: #666;
        color: #FFF;
        text-align: center;
        padding: .5rem;
        font-size: 1rem;
        cursor: pointer;
      }

      .empty em {
        font-weight: bold;
      }

      .advanced {
        padding: 0 15px;
      }

      @media (max-width: 768px) {
        .advanced {
          padding: 0 7px;
        }
      }
      
      .advanced .col-lg-4 {
        background: var(--light-background-color);
        padding-bottom: 1rem;
      }
      .advanced .col-lg-4 span {
        float: right;
        padding: 0.25rem 1rem 0 0;
        font-size: 0.875rem;
      }

      drop-down {
        width: 225px;
        display: inline-block;
        float: right;
      }

    </style>

    <iron-location 
      id="location"></iron-location>

    <app-route
        route="{{route}}"
        pattern="/search"
        data="{{routeData}}"
        tail="{{tail}}"></app-route>

    <app-viewport xl="{{xl}}" lg="{{lg}}" md="{{md}}" sm="{{sm}}"></app-viewport>        

    <app-spinner loading="[[spinner]]"></app-spinner>

    <div class="row">
      <div class="col-lg-12">
        <h2>
          <search-input type="text" value="{{search::input}}" autofocus submit="{{submit}}"></search-input>
        </h2>
      </div>
      <div class="col-lg-12">
        <div class="row advanced">
          <div class="col-lg-4">
            <div>
              <drop-down value="{{section}}" options=[[sectionOptions]] close="[[close]]"></drop-down>
              <span>Seccion</span>
            </div>
          </div>
          <div class="col-lg-4">
            <drop-down value="{{date}}" options=[[dateOptions]] close="[[close]]"></drop-down>
            <span>Fechas</span>
          </div>
          <div class="col-lg-4">
            <drop-down value="{{sort}}" options=[[sortOptions]] close="[[close]]"></drop-down>
            <span>Ordenar</span>
          </div>
        </div>
      </div>
    </div>

    <div class="results">

      <div class="empty" hidden$="[[!noResults]]">
        <p> No hay resultados para <em>[[keywords]]</em></p>

        <p>
          Sugerencias
          <ul>
            <li>Asegúrese de que las palabras esten escritas correctamente.</li>
            <li>Utilice diferentes palabras.</li>
            <li>Intente palabras más genéricas.</li>
          </ul>
        </p>
      </div>

      <p hidden$="[[empty]]">
        <span hidden$="[[!firstPage]]">Se encontraron [[totalResults]] resultados para: <em>[[keywords]]</em></span>
        <span hidden$="[[firstPage]]">Página [[page]] de [[totalResults]] resultados para: <em>[[keywords]]</em></span>
      </p>

      <div class="row">

        <template is="dom-repeat" items="{{results}}" as="news">

          <div class="col-lg-12">
            <a class="result" href="#/news/[[news.id]]">
              <div class="left" hidden$="[[!gMd]]">
                <h5>{{_dateFormat(news.date)}}</h5>
              </div>
              <template is="dom-if" if="{{gSm}}">
                <div hidden$="[[!news.img]]" right$="[[md]]" class="img">
                  <img src="[[news.img]]">
                </div>
              </template>
              <div class="right">
                <h5 hidden$="[[gMd]]">[[news.date]]</h5>
                <h4 class="section">[[news.section]]</h4>
                <h4>[[news.title]]</h4>
                <h6>[[news.desc]]</h6>
              </div>
            </a>
          </div>

        </template>

      </div>

      <app-pagination total="[[totalResults]]" current-page="[[page]]" requested-page="{{requestedPage}}"></app-pagination>

    </div>

  </template>

  <script>

    class PageSearch extends Polymer.GestureEventListeners(Polymer.Element) {
      static get is() { return 'page-search'; }
      static get properties() {
        return {

          queryParams: {
            type: String,
            value: null
          },

          search: {
            type: String,
            value: null
          },

          keywords: {
            type: String
          },

          results: {
            type: Array
          },

          submit: {
            type: Boolean,
            value: false,
            observer: '_submitChange'
          },

          page: {
            type: Number,
            value: 1
          },

          totalResults: {
            type: Number,
            value: 0
          },

          spinner: {
            type: Boolean,
            value: false
          },

          noResults: {
            type: Boolean,
            value: false
          },

          more: {
            type: Boolean,
            value: false
          },

          empty: {
            type: Boolean,
            value: true
          },

          gMd: {
            type: Boolean,
            value: false
          },

          gSm: {
            type: Boolean,
            value: false
          },

          section: {
            type: String,
            observer: '_paramChange'
          },

          sectionOptions: {
            type: Array
          },

          sort: {
            type: String,
            observer: '_paramChange'
          },

          sortOptions: {
            type: Array,
            value: [
              { value: 'r', desc: 'Relevancia' },
              { value: 'd', desc: 'Fecha' },
              { value: 'l', desc: 'Votos' }
            ]
          },

          date: {
            type: String,
            observer: '_paramChange'
          },

          dateOptions: {
            type: Array,
            value: [
              { value: 0, desc: 'Todo desde 2010' },
              { value: 1, desc: 'Ultimas 24 horas' },
              { value: 7, desc: 'Ultima Semana' },
              { value: 30, desc: 'Ultimo Mes' },
              { value: 90, desc: 'Ultimos 3 meses' },
              { value:365, desc: 'Ultimo año' }
            ]
          },

          close: {
            type: Boolean,
            value: false
          },

          debounce: {
            type: Boolean,
            value: false
          },

          requestedPage: {
            type: Number,
            value: null,
            observer: '_requestedPageChanged'
          },

          totalPages: {
            type: Number,
            value: 0
          },

          firstPage: {
            type: Boolean,
            value: true
          }

        };
      }

      static get observers() {
        return [
          '_searchChanged(tail)',
          '_greaterSm(xl, lg, md)'
        ];
      }

      constructor() {
        super();

        if(window.sections) {
          this._sectionList();
        } else {
          window.store.subscribe('sections-loaded', this._sectionList.bind(this));
        }

      }

      _sectionList() {
        window.sections[0].desc = 'Todas';
        this.sectionOptions = window.sections;
      }

      _searchChanged() {
        if(!this.debounce) {
          this.debounce = true;
          setTimeout(() => {
            this.debounce = false;
          }, 300);

          let keywords = this._getParameterByName('k', null),
              section = this._getParameterByName('s', 0),
              date = this._getParameterByName('d', 0),
              sort = this._getParameterByName('o', 'r'),
              page = this._getParameterByName('p', 1);

          this.section = section;
          this.date = date;
          this.sort = sort;
          this.page = page;

          if(keywords && keywords.length>0) {
            this.keywords = keywords.replace(/\+/g, " ");

            this.search = this.keywords.replace(/\+/g, " ");

            //let api = 'json/news/search.json?k=' + keywords.replace(/\-/g, "+") + this._getParams();
            let api = 'json/news/search.asp?k=' + keywords.replace(/\-/g, "+") + this._getParams();
            
            this.spinner = true;

            window.ajax.request('GET', api, null, (data) => {

              this.spinner = false;
              this.results = data.results;
              this.more = data.more;
              this.totalResults = data.total;
              if(data.results.length>0) {
                this.noResults = false;
                this.empty = false;
              } else {
                this.noResults = true;
                this.more = false;
                this.empty = true;
              }
              this.firstPage = (this.page == 1);

              this.totalPages = parseInt(this.totalResults / 10);
              if (this.totalPages * 10 < this.totalResults) {
                  this.totalPages++;
              }

            }, (err) => this.setData(err));

          } else {
            this.keywords = '';
            this.results = [];
            this.empty = true;
            this.more = false;
            this.totalResults = 0;
          }
        }

      }

      _getParams() {
        let params = '';

        if(this.section && this.section != 0) {
          params = params + "&s=" + this.section;
        }

        if(this.date && this.date != 0) {
          params = params + "&d=" + this.date;
        }

        if(this.sort && this.sort != 'r') {
          params = params + "&o=" + this.sort;
        }

        if(this.page && this.page != 1) {
          params = params + "&p=" + this.page;
        }

        return params;
      }

      _submitChange() {
        if(this.submit) {
          this.page = 1;
          this._search();
        }
      }

      _paramChange() {
        if(!this.debounce) {
          this.page = 1;
          this._search();
        }
      }

      _search() {
        if(!this.search || this.search.length == 0) return;

        this.close = true;
        this.requestedPage = null;

        setTimeout(() => {
          this.close = false;
        }, 100);

        let params = "?k=" + this.search.replace(/\s+/g,' ').trim().replace(/ /g, "+") + this._getParams();

        this.$.location.set('hash', '/search/'+params);
      }

      _greaterSm(xl, lg, md) {
        this.gMd = (xl || lg);
        this.gSm = (xl || lg || md);
      }

      _getParameterByName(field, value) {
        var href = window.location.href;
        var reg = new RegExp( '[?&]' + field + '=([^&#]*)', 'i' );
        var string = reg.exec(href);

        return string ? decodeURIComponent(string[1]) : value;
      }

      _requestedPageChanged() {
        if (this.requestedPage) {
          this.page = this.requestedPage;
          window.scrollTo(0, 0);

          this.close = true;

          setTimeout(() => {
            this.close = false;
          }, 100);

          let params = "?k=" + this.search.replace(/\s+/g,' ').trim().replace(/ /g, "+") + this._getParams();

          this.$.location.set('hash', '/search/'+params);
        } 
      }

      _dateFormat(dt) {
        let tmp = dt.split('/'),
            nw = tmp[2] + '/' + ((tmp[0].length<2) ? '0' : '') + tmp[0] + '/' + ((tmp[1].length<2) ? '0' : '') + tmp[1];
        return nw;
      }

    }

    window.customElements.define(PageSearch.is, PageSearch);
  </script>
</dom-module>