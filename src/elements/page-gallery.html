<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/app-route/app-route.html">
<link rel="import" href="./util/app-viewport.html">
<link rel="import" href="./blocks/block-banner.html">
<link rel="import" href="../styles/shared.html">

<dom-module id="page-gallery">
  <template>
    <style include="shared">

      :host {
        display: block;
        background-color: #eee;
        padding-bottom: 1rem;
      }
      *, *:after, *:before {
        @apply --initial;
      }
      .gallery {
        width: 100%;
        height: 600px;
        margin: 0 0 1rem;
      }
      .picture {
        position: relative;
        margin: auto;
        height: 100%;
        width: 100%;
        max-width: 800px;
        overflow: hidden;

        display: flex;
        justify-content: center;
        
      }
      .gallery img {
        display: block;
        margin: auto;
        cursor: pointer;
      }
      .gallery img {
        width: auto;
        height: 100%;
      }
      .gallery img[horizontal] {
        width: 100%;
        height: auto;
      }

      .gallery h6 {
        position: absolute;
        bottom: 0;
        color: #fff;
        @apply --joornalo-h6;
        background-color: rgba(0,0,0,.5);
        padding: 1rem 2rem .5rem;
      }

      .gallery .left,
      .gallery .right {
        display: block;
        cursor: pointer;
        font-size: 2.5rem;
        color: #fff;
        opacity: .4;
      }

      .gallery .left {
        position: absolute;
        top: 45%;
        left: 0.5rem;
        color: red;
      }
      .gallery .right {
        position: absolute;
        top: 45%;
        right: 0.5rem;
        color: red;
      }

      .left:hover,
      .right:hover {
        opacity: 1;
      }
      [class^="icon-"], [class*=" icon-"] {
        @apply --joornalo-icon;
        cursor: pointer;
        color: #666;
      }
      [class^="icon-"]:hover, [class*=" icon-"]:hover {
        color: #999;
      }

      .icon-circle-right:before {
        content: "\ea42";
        color: #fff;
        text-shadow: 0 1px 1px #000;
      }
      .icon-circle-left:before {
        content: "\ea44";
        color: #fff;
        text-shadow: 0 1px 1px #000;
      }

    </style>

    <app-route
        route="{{route}}"
        pattern="/gallery/:id"
        data="{{routeData}}"></app-route>

    <app-viewport xl="{{xl}}" lg="{{lg}}" md="{{md}}" sm="{{sm}}"></app-viewport>

    <div class="page-title">
      <h3><a href="#/galleries">Foto Galer√≠as</a> | [[title]]</h3>
    </div>

    <div class="row">
      <div class="col-lg-12">
        <div class="gallery">

          <div class="picture" on-tap="_right">
            <template is="dom-if" if="{{picture.img}}">
              <img id="image" horizontal$="[[horizontal]]" src="[[picture.img]]">
            </template>
            <h6 hidden$="[[!picture.desc]]">[[picture.desc]]</h6>

            <div class="left" on-tap="_left">
              <span class="icon-circle-left"></span>
            </div>
            <div class="right">
              <span class="icon-circle-right"></span>
            </div>

          </div>

        </div>
      </div>
    </div>

    <template is="dom-if" if="{{gMd}}">
      <div class="row">
        <div class="col-12">
          <div class="margin-bottom">
            <block-banner size="b980x90" module="4"></block-banner>
          </div>
        </div>
      </div>
    </template>

  </template>

  <script>

    class PageGallery extends Polymer.GestureEventListeners(Polymer.Element) {
      static get is() { return 'page-gallery'; }
      static get properties() {
        return {

          id: {
            type: String
          },

          picture: {
            type: Object,
            value: null,
            observer: '_pictureChanged'
          },

          horizontal: {
            type: Boolean,
            value: false
          },

          gallery: {
            type: Array
          },

          currentImage: {
            type: Number,
            value: 0
          },

          totalImages: {
            type: Number,
            value: 0
          },

          cancelRight: {
            type: Boolean,
            value: false
          },

          gMd: {
            type: Boolean,
            value: false
          },

          loadedData: {
            type: Array,
            value: []
          }

        };
      }

      static get observers() {
        return [
          '_galleryChanged(routeData.id)',
          'greaterMd(xl, lg)'
        ]
      }

      constructor() {
        super();
      }

      greaterMd(xl, lg) {
        this.gMd = (xl || lg);
      }

      _pictureChanged() {
        setTimeout(() => {
          let x = this.$.image.naturalWidth,
              y = this.$.image.naturalHeight;
          this.horizontal = (x > y);
          // console.log('href ', this.picture);
          // console.log(x, ' --- ', y, ' ---> ', this.horizontal);
        }, 100);
      }

      _galleryChanged(id) {
        if(this.loadedData[id]) {
          let timeDiff = (Date.now() - this.loadedData[id].time) / 1000 / 60;
          // only data from Gallery is more than 10 minutes old
          if (timeDiff > 10) {
            this._loadGallery(id);
          } else {
            this._setData(this.loadedData[id].data);
          }
        } else {
          this._loadGallery(id);
        }

      }

      _loadGallery(id) {
        this.id = id;
        //let api = 'json/media/gallery.json'; //' + id; //'json/gallery?i=' + id;
        let api = 'json/media/gallery.asp?id=' + id;
        window.ajax.request('GET', api, null, (data) => {
          this._setData(data);
          this.loadedData[id] = {
            time: Date.now(),
            data: data
          }
        }, (err) => this.setData(err));

      }

      _setData(data) {
        this.title = data.title;
        this.gallery = data.images;
        this.totalImages = data.images.length - 1;
        this.picture = this.gallery[0];
      }

      _left() {
        this.cancelRight = true;
        this.currentImage--;
        if(this.currentImage < 0) this.currentImage = this.totalImages;
        this.picture = this.gallery[this.currentImage];
      }

      _right() {
        if (!this.cancelRight) {
          this.currentImage++;
          if(this.currentImage > this.totalImages) this.currentImage = 0
          this.picture = this.gallery[this.currentImage];
        }
        this.cancelRight = false;
      }

    }

    window.customElements.define(PageGallery.is, PageGallery);
  </script>
</dom-module>