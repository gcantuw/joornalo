<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="./util/app-viewport.html">
<link rel="import" href="./blocks/block-banner.html">
<link rel="import" href="../styles/shared.html">

<dom-module id="page-galleries">
  <template>
    <style include="shared">
      :host {
        display: block;
      }

      *, *:after, *:before {
        @apply --initial;
      }
      
      .galleries {
        margin: 0 0 4rem;
      }

      .gallery {
        display: block;
        position: relative;
        margin: 0 0 2rem;
        color: #000;
      }
      .gallery h6 {
        position: absolute;
        width: 100%;
        bottom: 0;
        color: #FFF;
        @apply --joornalo-h6;
        font-weight: 700;
        text-shadow: 0 1px 1px #000;
        padding: 0 .5rem;
      }
      
      a:before {
        background: rgba(0,0,0,.15);
        content: '';
        display: block;
        height: 100%;
        position: absolute;
        top: 0;
        -webkit-transition: background-color .15s ease-out;
        -moz-transition: background-color .15s ease-out;
        transition: background-color .15s ease-out;
        width: 100%;
        z-index: 2;
      }
      a:hover:before {
        background: none;
      }

      img {
        margin-bottom: -5px;
      }
          
    </style>

    <app-viewport xl="{{xl}}" lg="{{lg}}" md="{{md}}" sm="{{sm}}"></app-viewport>

    <div class="page-title">
      <h3>Foto Galer√≠as</h3>
    </div>

    <template is="dom-if" if="{{gMd}}">
      <div class="row">
        <div class="col-12">
          <div class="margin-bottom">
            <block-banner size="b980x90" module="3"></block-banner>
          </div>
        </div>
      </div>
    </template>

    <div class="galleries">
      <div class="row">

        <template is="dom-repeat" items="{{topGalleries}}" as="gallery">

          <div class="col-lg-4 col-md-4">
            <a href="gallery/[[gallery.id]]" class="gallery">
              <img src="[[gallery.img]]">
              <h6>[[gallery.title]]</h6>
            </a>
          </div>

        </template>

      </div>

      <div class="row">

        <template is="dom-repeat" items="{{galleries}}" as="gallery">

          <div class="col-lg-3 col-md-4">
            <a href="gallery/[[gallery.id]]" class="gallery">
              <img src="[[gallery.img]]">
              <h6>[[gallery.title]]</h6>
            </a>
          </div>

        </template>

      </div>
    </div>

  </template>

  <script>
  
    class PageGalleries extends Polymer.Element {
      static get is() { return 'page-galleries'; }
      static get properties() {
        return {

          galleries: {
            type: Array
          },
          
          topGalleries: {
            type: Array,
            value: null
          },

          gMd: {
            type: Boolean,
            value: false
          },

          time: {
            type: Number
          }

        };
      }

      static get observers() {
        return [
          'greaterMd(xl, lg)'
        ]
      }

      constructor() {
        super();
        this._getData();
        window.store.subscribe('galleries', this._getData.bind(this));
      }

      greaterMd(xl, lg) {
        this.gMd = (xl || lg);
      }

      _getData() {
        if(this.galleries) {
          let timeDiff = (Date.now() - this.time) / 1000 / 60;
          // only data from Galleries is more than 10 minutes old
          if (timeDiff > 10) {
            this._loadData();
          }
        } else {
          this._loadData();
        }
      }

      _loadData() {

        //let api = 'json/media/galleries.json';
        let api = 'json/media/galleries.asp';

        window.ajax.request('GET', api, null, (data) => {

          let tmp = [],
              galleries = data.data;

          if(galleries) {
            let y = 0,
                i = galleries.length;
            for(;y < 3 && i > y; y++) {
              tmp.push(galleries[y]);
            }
            this.topGalleries = tmp;

            tmp = [];
            for(;i > y; y++) {
              tmp.push(galleries[y]);
            }
            this.galleries = tmp;
            this.time = Date.now();

          }

        }, (err) => this.setData(err));

      }
    }

    window.customElements.define(PageGalleries.is, PageGalleries);
  </script>
</dom-module>
