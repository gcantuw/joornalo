<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/app-route/app-location.html">
<link rel="import" href="../bower_components/app-route/app-route.html">
<link rel="import" href="../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="my-icons.html">
<link rel="import" href="./styles/shared.html">

<link rel="import" href="./elements/blocks/block-header.html">
<link rel="import" href="./elements/blocks/block-footer.html">
<link rel="lazy-import" href="elements/page-front.html">
<link rel="lazy-import" href="elements/page-news.html">
<link rel="lazy-import" href="elements/page-galleries.html">
<link rel="lazy-import" href="elements/page-gallery.html">
<link rel="lazy-import" href="elements/page-search.html">
<link rel="lazy-import" href="elements/page-multimedia.html">
<link rel="lazy-import" href="elements/page-notfound.html">

<dom-module id="joornalo-app">
  <template>
    <style include="shared">
      :host {
        display: block;
      }

      .content {
        min-height: 700px;
      }
      
    </style>


    <app-location id="location" route="{{route}}" url-space-regex="^[[rootPath]]" use-hash-as-path></app-location>
    <app-route route="{{route}}" pattern="[[rootPath]]:page" data="{{routeData}}" tail="{{subroute}}"></app-route>

    <block-header menu=[[menuHeader]]></block-header>

    <div class="container-fluid">

      <div class="content">
        <iron-pages selected="[[page]]" attr-for-selected="name" fallback-selection="notfound" selected-attribute="route" selected-attribute-value="{{subroute}}" role="main">

          <page-front name="front" route="[[route]]"></page-front>

          <page-news name="news" route="[[route]]"></page-news>

          <page-galleries name="galleries"></page-galleries>

          <page-gallery name="gallery" route="[[route]]"></page-gallery>

          <page-search name="search" route="[[route]]"></page-search>

          <page-multimedia name="multimedia" route="[[route]]"></page-multimedia>

          <page-notfound name="notfound"></page-notfound>
          
        </iron-pages>
      </div>

    </div>
    
    <block-footer menu=[[menuHeader]] menu-footer=[[menuFooter]]></block-footer>

  </template>

  <script>
    const ORIGINAL_TITLE = document.title;

    class JoornaloApp extends Polymer.Element {
      static get is() { return 'joornalo-app'; }

      static get properties() {
        return {
          route: Object,
          page: {
            type: String,
            reflectToAttribute: true,
            observer: '_pageChanged',
          },
          routeData: Object,
          subroute: String,
          // This shouldn't be neccessary, but the Analyzer isn't picking up
          // Polymer.Element#rootPath
          rootPath: String,

          menuHeader: Object,
          menuFoter: Object
        };
      }

      static get observers() {
        return [
          '_routePageChanged(routeData.page)',
        ];
      }

      ready() {
        super.ready();

        let api = 'json/menu.asp';

        window.store.subscribe('meta-tags', this._updateMetaTags.bind(this));

        window.ajax.request('GET', api, null, (data) => {

          this.menuHeader = data['menu-header'];
          this.menuFooter = data['menu-footer'];
          window.sectionId = data['section-id'];
          window.sections = data['sections'];
          window.sectionClave = data['section-clave'];
          window.store.publish('sections-loaded', {});
          window.sectionName = [];
          data['sections'].forEach((element) => {
            window.sectionName[element.value] = element.desc;
          });

        }, (err) => this.setData(err));

      }

      _routePageChanged(page) {
        window.scrollTo(0, 0);
        window.store.publish('banner-reset', {});
        gtag('config', window.GA_TRACKING_ID, { 'page_path': this.subroute.prefix + this.subroute.path });
        gtag('config', window.GA_TRACKING_ID);

        if (this.route.path == '' || this.route.path == '/' || this.route.path == '/front') {
          console.log('----');
          this.$.location.set('path', '/front/home');
        } else {
          this.page = page || 'front';
        }
      }

      _pageChanged(page) {
        // Load page import on demand. Show 404 page if fails
        var resolvedPageUrl = this.resolveUrl('elements/page-' + page + '.html');
        Polymer.importHref(
            resolvedPageUrl,
            null,
            this._showPage404.bind(this),
            true);

        window.store.publish(page, page);
        window.store.publish('page-change', page);
        window.scrollTo(0, 0);
      }

      _showPage404() {
        this.page = 'notfound';
      }

      _updateMetaTags(tags) {
        //console.log(tags);

        let title = (tags && tags.title.length > 0) ? `${tags.title} - ${ORIGINAL_TITLE}` : `${ORIGINAL_TITLE}`;

        document.title = title;
        document.querySelector("meta[property='og:title']").content = title;
        document.querySelector("meta[property='og:description']").content = tags.description;
        document.querySelector("meta[name='description']").content = tags.description;
        //document.querySelector("meta[property='og:image']").content = tags.image;
        //document.querySelector("meta[name='twitter:card']").content = tags.image;
        document.querySelector("meta[name='twitter:image:alt']").content = tags.imgAltName;
        document.querySelector("meta[property='og:url']").content = tags.url;

        var link=document.createElement('meta');
        link.property="og:image";
        link.content=tags.image;
        document.getElementsByTagName('head')[0].appendChild(link);

      }

    }

    window.customElements.define(JoornaloApp.is, JoornaloApp);
  </script>
</dom-module>
